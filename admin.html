<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - é«˜ä¸­å›å¿†å½•</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .admin-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .admin-tab {
            cursor: pointer;
            padding: 5px 10px;
            font-weight: bold;
        }
        .admin-tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="admin-container" id="login-section">
        <h2 style="text-align: center; margin-bottom: 20px;">åå°ç®¡ç†ç™»å½•</h2>
        <form id="admin-login-form" style="max-width: 300px; margin: 0 auto;">
            <div class="form-group">
                <label>ç®¡ç†å‘˜è´¦å·</label>
                <input type="text" name="username" required>
            </div>
            <div class="form-group">
                <label>ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">ç™»å½•</button>
        </form>
    </div>

    <div class="admin-container" id="dashboard-section" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>åå°ç®¡ç†ç³»ç»Ÿ</h2>
            <div>
                <a href="index.html" style="margin-right: 15px; text-decoration: none; color: #333;">è¿”å›é¦–é¡µ</a>
                <button class="btn" onclick="adminLogout()">é€€å‡º</button>
            </div>
        </div>
        
        <div class="admin-nav">
            <div class="admin-tab active" onclick="switchTab('users')">ç”¨æˆ·ç®¡ç†</div>
            <div class="admin-tab" onclick="switchTab('memoirs')">å›å¿†ç®¡ç†</div>
            <div class="admin-tab" onclick="switchTab('announcements')">å…¬å‘Šç®¡ç†</div>
            <div class="admin-tab" onclick="switchTab('topics')">è¯é¢˜ç®¡ç†</div>
        </div>

        <div id="users-section" class="section active">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>å§“å</th>
                        <th>è´¦å·</th>
                        <th>ç­çº§</th>
                        <th>æ³¨å†Œæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="user-list">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>

        <div id="memoirs-section" class="section">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>å‘å¸ƒè€…</th>
                        <th>å†…å®¹é¢„è§ˆ</th>
                        <th>å‘å¸ƒæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="memoir-list">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>

        <div id="announcements-section" class="section">
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                <h4>å‘å¸ƒæ–°å…¬å‘Š</h4>
                <form id="announcement-form" style="margin-top: 10px;">
                    <textarea name="content" style="width: 100%; height: 80px; padding: 10px; margin-bottom: 10px;" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹..." required></textarea>
                    <button type="submit" class="btn btn-primary">å‘å¸ƒ</button>
                </form>
            </div>
            
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>å†…å®¹</th>
                        <th>å‘å¸ƒæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="announcement-list">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>

        <div id="topics-section" class="section">
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                <p>ğŸ’¡ è¯é¢˜ç”±ç”¨æˆ·åœ¨å‘å¸ƒå›å¿†æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œç®¡ç†å‘˜å¯åœ¨æ­¤ç®¡ç†è¿è§„è¯é¢˜ã€‚</p>
            </div>
            
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>è¯é¢˜åç§°</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="topic-list">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = 'api/';
        
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            formData.append('action', 'login');
            
            const res = await fetch(API_BASE + 'admin.php', { method: 'POST', body: formData });
            const data = await res.json();
            
            if (data.success) {
                showDashboard();
            } else {
                alert(data.message);
            }
        });

        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            loadUsers();
            loadMemoirs();
            loadAnnouncements();
            loadTopics();
        }

        async function adminLogout() {
            const formData = new FormData();
            formData.append('action', 'logout');
            await fetch(API_BASE + 'admin.php', { method: 'POST', body: formData });
            window.location.reload();
        }

        function switchTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-section').classList.add('active');
        }

        document.getElementById('announcement-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            formData.append('action', 'add_announcement');
            const res = await fetch(API_BASE + 'admin.php', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                alert('å‘å¸ƒæˆåŠŸ');
                e.target.reset();
                loadAnnouncements();
            } else {
                alert(data.message);
            }
        });

        async function loadUsers() {
            const res = await fetch(`${API_BASE}admin.php?action=list_users`);
            const data = await res.json();
            if (data.success) {
                const tbody = document.getElementById('user-list');
                tbody.innerHTML = '';
                data.users.forEach(u => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.name}</td>
                            <td>${u.username}</td>
                            <td>${u.class}</td>
                            <td>${u.created_at}</td>
                            <td><span class="delete-btn" onclick="deleteUser(${u.id})">åˆ é™¤</span></td>
                        </tr>
                    `;
                });
            }
        }

        async function loadMemoirs() {
            const res = await fetch(`${API_BASE}admin.php?action=list_memoirs`);
            const data = await res.json();
            if (data.success) {
                const tbody = document.getElementById('memoir-list');
                tbody.innerHTML = '';
                data.memoirs.forEach(m => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${m.id}</td>
                            <td>${m.author_name}</td>
                            <td>${m.content.substring(0, 30)}...</td>
                            <td>${m.created_at}</td>
                            <td><span class="delete-btn" onclick="deleteMemoir(${m.id})">åˆ é™¤</span></td>
                        </tr>
                    `;
                });
            }
        }

        async function loadAnnouncements() {
            const res = await fetch(`${API_BASE}admin.php?action=list_announcements`);
            const data = await res.json();
            if (data.success) {
                const tbody = document.getElementById('announcement-list');
                tbody.innerHTML = '';
                data.announcements.forEach(a => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${a.id}</td>
                            <td>${a.content.substring(0, 50)}...</td>
                            <td>${a.created_at}</td>
                            <td><span class="delete-btn" onclick="deleteAnnouncement(${a.id})">åˆ é™¤</span></td>
                        </tr>
                    `;
                });
            }
        }

        async function loadTopics() {
            const res = await fetch(`${API_BASE}admin.php?action=list_topics`);
            const data = await res.json();
            if (data.success) {
                const tbody = document.getElementById('topic-list');
                tbody.innerHTML = '';
                data.topics.forEach(t => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${t.id}</td>
                            <td>${t.name}</td>
                            <td>${t.created_at}</td>
                            <td><span class="delete-btn" onclick="deleteTopic(${t.id})">åˆ é™¤</span></td>
                        </tr>
                    `;
                });
            }
        }

        async function deleteUser(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿè¿™å°†åˆ é™¤å…¶æ‰€æœ‰å›å¿†å’Œè¯„è®ºã€‚')) return;
            const formData = new FormData();
            formData.append('action', 'delete_user');
            formData.append('user_id', id);
            const res = await fetch(API_BASE + 'admin.php', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) loadUsers();
            else alert(data.message);
        }

        async function deleteMemoir(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å›å¿†å—ï¼Ÿ')) return;
            const formData = new FormData();
            formData.append('action', 'delete_memoir');
            formData.append('memoir_id', id);
            const res = await fetch(API_BASE + 'admin.php', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) loadMemoirs();
            else alert(data.message);
        }

        async function deleteAnnouncement(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿ')) return;
            const formData = new FormData();
            formData.append('action', 'delete_announcement');
            formData.append('id', id);
            const res = await fetch(API_BASE + 'admin.php', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) loadAnnouncements();
            else alert(data.message);
        }

        async function deleteTopic(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥è¯é¢˜å—ï¼Ÿ')) return;
            const formData = new FormData();
            formData.append('action', 'delete_topic');
            formData.append('id', id);
            const res = await fetch(API_BASE + 'admin.php', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) loadTopics();
            else alert(data.message);
        }
        
        // Check session on load (optional, but admin session is PHP only, so we rely on login form for now. 
        // If already logged in, we could check. But admin.php doesn't have a check_session action. 
        // We can add one or just let them login again (it's quick).
        // Let's add a quick check by trying to load users.
        (async () => {
             const res = await fetch(`${API_BASE}admin.php?action=list_users`);
             const data = await res.json();
             if (data.success) {
                 showDashboard();
             }
        })();
    </script>
</body>
</html>
